Response:
Let's break down the thought process for analyzing this Frida agent code snippet.

**1. Initial Understanding & Context:**

The prompt clearly states this is a Frida agent file (`fs_agent.js`) located in a specific directory. This immediately tells us:

* **Purpose:** It's likely involved in hooking or instrumenting file system related operations on a target process.
* **Environment:** It runs within the Frida environment, interacting with a target process.
* **Language:** JavaScript (as indicated by `.js`).
* **Key Technology:**  Frida's dynamic instrumentation capabilities are central.

**2. High-Level Code Structure & Imports:**

The first step is to scan the `import` statements and top-level declarations. This provides an overview of the code's dependencies and key components:

* **Imports:**  Notice the imports from `./utils.js`, `./writable.js`, and the `process` module. This suggests the agent builds upon standard Node.js stream concepts (`writable`) and potentially has custom utility functions.
* **Constants:** Look for declared constants like `ERR_INVALID_ARG_TYPE`, `ERR_INVALID_RETURN_VALUE`. These are often used for error handling and validation.
* **Class Definition:** The `j` class is the primary export and appears to be a core element. The `extends n.prototype` and `f.prototype` hint at inheritance or mixin patterns involving readable and writable streams.
* **Helper Functions:**  Functions like `O` and `m` are defined, suggesting they perform specific tasks, possibly related to stream conversion or creation.

**3. Dissecting the `j` Class:**

The `j` class is central. Let's analyze its key aspects:

* **Constructor:**  The constructor takes an argument `e`. It initializes properties related to `allowHalfOpen`, `readable`, and `writable` based on the presence and values within `e`. This strongly indicates it's configuring a stream.
* **Prototypal Inheritance/Mixin:** The `Object.setPrototypeOf` calls and the loop copying properties from `f.prototype` clearly indicate the `j` class is inheriting or mixing in functionalities from a `Readable` stream (`n`) and a `Writable` stream (`f`).
* **`writable` Property Definitions:**  The `Object.defineProperties` block meticulously defines getter methods for various writable stream properties (e.g., `writableHighWaterMark`, `writableFinished`). This confirms the `j` class is designed to behave like a writable stream.
* **`destroyed` Property:** The custom getter and setter for `destroyed` suggest managing the lifecycle of the stream.
* **`from` Static Method:** The `j.from` method calls the `O` function. This suggests a way to create instances of `j` from different input types.

**4. Analyzing Helper Functions `O` and `m`:**

* **`O(r, o)`:** This function is more complex and seems responsible for converting various input types (`r`) into streams. The checks for `p(r)` (duplex), `c(r)` (readable), `w(r)` (writable), and `s(r)` (closed stream) suggest handling existing streams. The handling of functions, async functions, iterables, and objects with `readable`/`writable` properties indicates a flexible stream creation mechanism. The promise-based logic within the function handling functions is noteworthy.
* **`m(e)`:** This function appears to wrap existing readable or writable streams (`e.readable`, `e.writable`) into a new duplex stream (`_`). It sets up event listeners (`readable`, `end`, `drain`, `finish`) and manages the flow of data between the wrapped streams.

**5. Connecting to Frida and File Systems (Answering Specific Prompts):**

Now, let's relate this to the prompt's requirements:

* **Frida Dynamic Instrumentation:** The code doesn't *directly* contain Frida-specific APIs (like `Interceptor.attach`). However, *because* the file path indicates it's a Frida agent, we know this code will be *used within* a Frida context. Its purpose is to provide a stream abstraction for file system interactions that can be manipulated by Frida.
* **Binary Underlying, Linux Kernel:** The code itself is high-level JavaScript and doesn't have direct kernel interactions. However, *the underlying Frida tools* that would *use* this agent likely *do* involve binary manipulation and kernel interaction. This agent provides a higher-level abstraction for those lower-level operations. For example, Frida might use system calls like `open`, `read`, `write`, and this agent helps manage the data flow around those calls.
* **lldb/Python Script Examples:** Since the code *implements* stream functionality, you wouldn't directly "replicate" its *logic* with lldb. Instead, you might use lldb/Python to *inspect* the state of the agent or the target process while this agent is active. You could set breakpoints within the agent or examine memory related to file I/O operations.
* **Logic Reasoning, Assumptions:** The code assumes that the provided input (`e` in the `j` constructor, `r` in `O`) conforms to certain stream-like interfaces. If these assumptions are violated, errors will likely occur.
* **User/Programming Errors:** Common errors would involve passing incorrect types to `j.from`, not handling stream events properly (like `data`, `end`, `error`), or creating streams that get into a stalled or error state.
* **User Operation to Reach Here:**  A user would typically:
    1. Write a Frida script that targets a specific process.
    2. Within that script, they might use Frida's file system API or a custom agent that leverages this `fs_agent.js` code.
    3. The Frida script would inject this agent into the target process.
    4. When the target process performs file system operations that are instrumented by this agent, this code will execute.
* **归纳功能 (Summarizing Functionality):** The code defines a custom duplex stream class (`j`) that simplifies the creation and manipulation of streams from various sources (other streams, promises, iterables, functions, etc.). It acts as a wrapper and adapter for different stream types, providing a consistent interface.

**6. Final Review and Refinement:**

After the initial analysis, review the code for any missed details or areas of uncertainty. Double-check the understanding of stream concepts and Frida's role. Ensure the explanation addresses all parts of the prompt. For instance, initially, I might not have explicitly connected the agent to the *underlying* Frida mechanisms interacting with the kernel. Refinement would involve making that connection clearer.这是一个Frida动态插桩工具的源代码文件，位于`frida/build/subprojects/frida-tools/agents/fs/fs_agent.js`，其主要功能是**创建一个灵活的、可组合的流处理工具，用于处理各种类型的输入，并将其转换为统一的Duplex（可读写）流**。

以下是更详细的功能说明，并结合您提出的要求进行解释：

**1. 核心功能：创建和转换流**

* **统一的Duplex流抽象：**  定义了一个名为 `j` 的类，它继承了 Node.js 的 `Readable` 和 `Writable` 流的特性，创建了一个可以同时读取和写入数据的 Duplex 流。
* **多种输入源支持：** `j.from()` 方法是其关键，它能够将多种不同的数据源转换为 `j` 类的 Duplex 流实例。支持的输入类型包括：
    * **已有的Node.js流 (Readable, Writable, Duplex):**  如果输入已经是流，则直接包装或根据需要进行一些调整。
    * **AsyncIterable 和 Iterable:** 将异步迭代器和同步迭代器转换为可读流。
    * **Async Function:**  将异步函数转换为可读流，函数内部可以使用 `yield` 产生数据。
    * **Promise:** 将 Promise 的结果作为可读流的数据。
    * **具有 `readable` 或 `writable` 属性的对象:** 如果对象拥有可读或可写流的属性，则将其包装成一个新的 Duplex 流。
* **流的半开支持：**  允许创建半开的流 (`allowHalfOpen`)，即一个方向的流结束后，另一个方向的流仍然可以继续工作。

**2. 涉及到的底层概念（间接体现）：**

虽然这段 JavaScript 代码本身是高层次的，但其功能是围绕流处理展开的，这与底层的操作系统和内核交互密切相关：

* **文件系统操作的基础：**  在 Frida 的 `fs` 模块的上下文中，这个 `fs_agent.js` 的目标很可能是为了拦截或处理文件系统的操作。底层的操作（如 `open`, `read`, `write`, `close`）最终会转化为系统调用，由 Linux 内核执行。这个 agent 提供的流抽象可以用来捕获、修改或重定向这些操作的数据流。
* **管道 (Pipes)：**  流的概念在操作系统中与管道的概念非常相似。管道允许将一个进程的输出连接到另一个进程的输入。这个 agent 提供的 Duplex 流可以被视为在用户空间模拟了这种管道机制，用于处理文件系统操作的数据流动。
* **缓冲区 (Buffers)：** 流在内部会使用缓冲区来存储数据。当进行读写操作时，数据会暂存在缓冲区中。虽然代码中没有直接操作 Buffer，但 Node.js 的流底层实现依赖于 Buffer。

**3. 用 lldb 指令或 Python 脚本复刻调试功能示例：**

由于这段代码本身是**实现流处理逻辑**的，而不是直接的调试功能，因此无法直接用 lldb 指令或 Python 脚本来“复刻”其功能。然而，如果这个 agent **被用于实现文件系统操作的调试功能**，我们可以演示如何用 lldb 或 Python 脚本来观察其行为或验证其效果：

**假设：**  `fs_agent.js` 被 Frida 用来拦截对 `open()` 系统调用的调用，并创建一个 `j` 类的 Duplex 流来读取打开的文件内容。

**lldb 示例：**

```lldb
# 设置断点在 open 系统调用 (假设目标架构是 x86_64)
breakpoint set -s libsystem_kernel.dylib -n open

# 运行目标进程
process launch

# 当断点命中时
bt  # 查看调用栈，确认是否与 Frida 或 agent 相关

# 查看 open 的参数，获取文件名
p/s $rdi  # 假设第一个参数是文件名

# 如果确认是目标文件操作，可以继续执行
continue
```

**Frida Python 脚本示例（模拟 `fs_agent.js` 的部分行为）：**

```python
import frida
import sys

def on_message(message, data):
    if message['type'] == 'send':
        print(f"[*] Received: {message['payload']}")
    else:
        print(message)

session = frida.attach(sys.argv[1])
script = session.create_script("""
    // 模拟 fs_agent.js 创建可读流并读取文件
    const fs = require('fs');
    const filePath = '/path/to/target/file'; // 替换为实际路径

    const readableStream = fs.createReadStream(filePath);

    readableStream.on('data', chunk => {
        send(chunk.toString());
    });

    readableStream.on('end', () => {
        send('File reading finished.');
    });

    readableStream.on('error', error => {
        send('Error reading file: ' + error);
    });
""")
script.on('message', on_message)
script.load()
sys.stdin.read()
```

**说明：**  上述 lldb 示例展示了如何在系统调用层面观察文件打开操作。Python 脚本则模拟了 `fs_agent.js` 可能执行的文件读取逻辑。要真正复刻 `fs_agent.js` 的全部功能，需要更复杂的 Frida 脚本来拦截系统调用并使用 agent 提供的流处理能力。

**4. 逻辑推理的假设输入与输出：**

**假设输入：** 一个包含字符串 "Hello, Frida!" 的 Buffer 对象。

**代码片段：**  如果这个 Buffer 对象被传递给 `j.from()`，并且该 Buffer 被识别为可读流（虽然 Buffer 本身不是流，但可能被 `O` 函数处理）。

**预期输出：**  创建一个 `j` 类的 Duplex 流实例，该流可以被读取，并最终产生字符串 "Hello, Frida!"。

**假设输入：** 一个返回字符串 "World!" 的 Promise。

**代码片段：**  将这个 Promise 传递给 `j.from()`。

**预期输出：** 创建一个 `j` 类的 Duplex 流实例，当 Promise resolve 后，该流可以被读取，并产生字符串 "World!"。

**5. 用户或编程常见的使用错误：**

* **传递不支持的输入类型给 `j.from()`：** 例如，传递一个简单的数字或 `null`。这将导致 `O` 函数抛出 `TypeError`。
* **未正确处理流事件：** 用户创建了一个 `j` 类的流后，没有监听 `data` 事件来接收数据，或者没有监听 `end` 事件来判断流的结束。
* **在流完成写入后尝试写入：**  对一个已经结束写入的流调用 `write()` 方法会抛出错误。
* **背压 (Backpressure) 处理不当：**  如果生产者以快于消费者处理的速度产生数据，可能导致内存问题。用户需要通过监听 `drain` 事件来合理控制数据写入的速度。

**示例：**

```javascript
// 错误示例：传递不支持的输入
const stream1 = j.from(123); // 可能会抛出 TypeError

// 错误示例：未处理 data 事件
const stream2 = j.from("some data");
// 数据不会被消费

// 错误示例：在流结束后写入
const stream3 = new j();
stream3.end();
stream3.write("more data"); // 抛出错误
```

**6. 用户操作是如何一步步的到达这里，作为调试线索：**

1. **用户编写 Frida 脚本：**  用户编写了一个 Frida 脚本，其目标是 hook 某个进程的文件系统操作。
2. **脚本加载 `fs_agent.js`：**  在 Frida 脚本中，可能使用了 `frida.add_host_script()` 或其他方式加载了这个 `fs_agent.js` 文件。
3. **Hook 文件系统 API：**  Frida 脚本使用 `Interceptor.attach()` 或类似的方法 hook 了 Node.js 的 `fs` 模块的某些函数（例如 `fs.readFile`, `fs.writeFile`），或者更底层的系统调用 `open`, `read`, `write` 等。
4. **在 Hook 中使用 `fs_agent.js`：**  当 hook 被触发时，脚本可能会调用 `require('./fs_agent.js')` 来使用其中定义的 `j` 类和 `j.from()` 方法，例如，将读取到的文件内容转换为流进行进一步处理或修改。
5. **目标进程执行文件系统操作：** 目标进程执行了被 hook 的文件系统操作，从而触发了 Frida 脚本中的 hook 代码，进而执行了 `fs_agent.js` 中的流处理逻辑。

**调试线索：**  如果用户在调试过程中发现与文件系统操作相关的问题，例如数据丢失、数据损坏、程序卡顿等，并且确认使用了自定义的 Frida agent，那么 `fs_agent.js` 的代码就是关键的调试线索。需要仔细检查其流的创建、转换、数据处理逻辑，以及是否存在潜在的错误使用或资源泄漏。

**7. 归纳其功能（第6部分，共12部分）：**

这段代码的主要功能是**提供一个强大的、可扩展的机制来创建和转换各种数据源为统一的 Duplex 流**。 它简化了在 Frida agent 中处理不同类型数据（例如文件内容、网络数据、内存数据等）的方式，并为后续的数据处理和操作提供了灵活的基础。 在一个更大的 Frida agent 中，这段代码很可能被用作构建更复杂的文件系统监控、修改或虚拟化功能的基础组件。

Prompt: 
```
这是目录为frida/build/subprojects/frida-tools/agents/fs/fs_agent.js的frida Dynamic instrumentation tool的源代码文件， 请列举一下它的功能, 
如果涉及到二进制底层，linux内核，请做出对应的举例说明，
请给出用lldb指令或者lldb python脚本，用来复刻的源代码所实现调试功能的示例，如果源代码是调试功能的实现。
如果做了逻辑推理，请给出假设输入与输出,
如果涉及用户或者编程常见的使用错误，请举例说明,
说明用户操作是如何一步步的到达这里，作为调试线索，
请用中文回复。
这是第6部分，共12部分，请归纳一下它的功能

"""
eStream as c,isWritableNodeStream as w,isDuplexNodeStream as p}from"./utils.js";import f from"./writable.js";import u from"process";const{ERR_INVALID_ARG_TYPE:y,ERR_INVALID_RETURN_VALUE:h}=o;Object.setPrototypeOf(j.prototype,n.prototype),Object.setPrototypeOf(j,n);for(const g of Object.keys(f.prototype))j.prototype[g]||(j.prototype[g]=f.prototype[g]);export default function j(e){if(!(this instanceof j))return new j(e);n.call(this,e),f.call(this,e),e?(this.allowHalfOpen=!1!==e.allowHalfOpen,!1===e.readable&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),!1===e.writable&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)):this.allowHalfOpen=!0}Object.defineProperties(j.prototype,{writable:Object.getOwnPropertyDescriptor(f.prototype,"writable"),writableHighWaterMark:Object.getOwnPropertyDescriptor(f.prototype,"writableHighWaterMark"),writableObjectMode:Object.getOwnPropertyDescriptor(f.prototype,"writableObjectMode"),writableBuffer:Object.getOwnPropertyDescriptor(f.prototype,"writableBuffer"),writableLength:Object.getOwnPropertyDescriptor(f.prototype,"writableLength"),writableFinished:Object.getOwnPropertyDescriptor(f.prototype,"writableFinished"),writableCorked:Object.getOwnPropertyDescriptor(f.prototype,"writableCorked"),writableEnded:Object.getOwnPropertyDescriptor(f.prototype,"writableEnded"),writableNeedDrain:Object.getOwnPropertyDescriptor(f.prototype,"writableNeedDrain"),destroyed:{get(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set(e){this._readableState&&this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}}}),j.from=function(e){return O(e,"body")};class _ extends j{constructor(e){super(e),!1===e?.readable&&(this._readableState.readable=!1,this._readableState.ended=!0,this._readableState.endEmitted=!0),!1===e?.writable&&(this._writableState.writable=!1,this._writableState.ending=!0,this._writableState.ended=!0,this._writableState.finished=!0)}}function O(r,o){if(p(r))return r;if(c(r))return m({readable:r});if(w(r))return m({writable:r});if(s(r))return m({writable:!1,readable:!1});if("function"==typeof r){const{value:n,write:l,final:b,destroy:s}=function(t){let{promise:r,resolve:o}=S();const i=new e,n=i.signal;return{value:t(async function*(){for(;;){const{chunk:e,done:t,cb:i}=await r;if(u.nextTick(i),t)return;if(n.aborted)throw new a;yield e,({promise:r,resolve:o}=S())}}(),{signal:n}),write(e,t,r){o({chunk:e,done:!1,cb:r})},final(e){o({done:!0,cb:e})},destroy(e,t){i.abort(),t(e)}}}(r);if(d(n))return i(_,n,{objectMode:!0,write:l,final:b,destroy:s});const c=n?.then;if("function"==typeof c){let e;const r=c.call(n,(e=>{if(null!=e)throw new h("nully","body",e)}),(r=>{t(e,r)}));return e=new _({objectMode:!0,readable:!1,write:l,final(e){b((async()=>{try{await r,u.nextTick(e,null)}catch(t){u.nextTick(e,t)}}))},destroy:s})}throw new h("Iterable, AsyncIterable or AsyncFunction",o,n)}if(d(r))return i(_,r,{objectMode:!0,writable:!1});if("object"==typeof r?.writable||"object"==typeof r?.readable){return m({readable:r?.readable?c(r?.readable)?r?.readable:O(r.readable):void 0,writable:r?.writable?w(r?.writable)?r?.writable:O(r.writable):void 0})}const n=r?.then;if("function"==typeof n){let e;return n.call(r,(t=>{null!=t&&e.push(t),e.push(null)}),(r=>{t(e,r)})),e=new _({objectMode:!0,writable:!1,read(){}})}throw new y(o,["Blob","ReadableStream","WritableStream","Stream","Iterable","AsyncIterable","Function","{ readable, writable } pair","Promise"],r)}function m(e){const o=e.readable&&"function"!=typeof e.readable.read?n.wrap(e.readable):e.readable,i=e.writable;let d,s,c,w,p,f=!!l(o),u=!!b(i);function y(e){const t=w;w=null,t?t(e):e?p.destroy(e):f||u||p.destroy()}return p=new _({readableObjectMode:!!o?.readableObjectMode,writableObjectMode:!!i?.writableObjectMode,readable:f,writable:u}),u&&(r(i,(e=>{u=!1,e&&t(o,e),y(e)})),p._write=function(e,t,r){i.write(e,t)?r():d=r},p._final=function(e){i.end(),s=e},i.on("drain",(function(){if(d){const e=d;d=null,e()}})),i.on("finish",(function(){if(s){const e=s;s=null,e()}}))),f&&(r(o,(e=>{f=!1,e&&t(o,e),y(e)})),o.on("readable",(function(){if(c){const e=c;c=null,e()}})),o.on("end",(function(){p.push(null)})),p._read=function(){for(;;){const e=o.read();if(null===e)return void(c=p._read);if(!p.push(e))return}}),p._destroy=function(e,r){e||null===w||(e=new a),c=null,d=null,s=null,null===w?r(e):(w=r,t(i,e),t(o,e))},p}function S(){let e,t;return{promise:new Promise(((r,a)=>{e=r,t=a})),resolve:e,reject:t}}
✄
{"version":3,"file":"end-of-stream.js","names":["AbortError","errorCodes","once","isClosed","isReadable","isReadableNodeStream","isReadableFinished","isWritable","isWritableNodeStream","isWritableFinished","isNodeStream","_willEmitClose","process","ERR_STREAM_PREMATURE_CLOSE","isRequest","stream","setHeader","abort","nop","eos","options","callback","arguments","length","readable","writable","wState","_writableState","rState","_readableState","onlegacyfinish","onfinish","willEmitClose","writableFinished","destroyed","readableFinished","call","onend","onerror","err","closed","onclose","errored","onrequest","req","on","aborted","error","nextTick","errorEmitted","cleanup","removeListener","signal","endCallback","originalCallback","args","removeEventListener","apply","addEventListener"],"sourceRoot":"/root/frida/build/subprojects/frida-tools/agents/fs/fs_agent.js.p/node_modules/@frida/readable-stream/lib/","sources":[""],"mappings":"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"}
✄
import{AbortError as e,codes as r}from"../errors.js";import o from"./once.js";import{isClosed as t,isReadable as n,isReadableNodeStream as s,isReadableFinished as i,isWritable as l,isWritableNodeStream as a,isWritableFinished as c,isNodeStream as d,willEmitClose as m}from"./utils.js";import b from"process";const{ERR_STREAM_PREMATURE_CLOSE:f}=r;function v(e){return e.setHeader&&"function"==typeof e.abort}const L=()=>{};export default function p(r,p,u){2===arguments.length?(u=p,p={}):null==p&&(p={}),u=o(u);const E=p.readable||!1!==p.readable&&s(r),w=p.writable||!1!==p.writable&&a(r);d(r);const q=r._writableState,T=r._readableState,x=()=>{r.writable||h()};let y=m(r)&&s(r)===E&&a(r)===w,g=c(r,!1);const h=()=>{g=!0,r.destroyed&&(y=!1),(!y||r.readable&&!E)&&(E&&!k||u.call(r))};let k=i(r,!1);const R=()=>{k=!0,r.destroyed&&(y=!1),(!y||r.writable&&!w)&&(w&&!g||u.call(r))},_=e=>{u.call(r,e)};let S=t(r);const j=()=>{S=!0;const e=q?.errored||T?.errored;return e&&"boolean"!=typeof e?u.call(r,e):(!E||k||i(r,!1))&&(!w||g||c(r,!1))?void u.call(r):u.call(r,new f)},A=()=>{r.req.on("finish",h)};v(r)?(r.on("complete",h),y||r.on("abort",j),r.req?A():r.on("request",A)):w&&!q&&(r.on("end",x),r.on("close",x)),y||"boolean"!=typeof r.aborted||r.on("aborted",j),r.on("end",R),r.on("finish",h),!1!==p.error&&r.on("error",_),r.on("close",j),S?b.nextTick(j):q?.errorEmitted||T?.errorEmitted?y||b.nextTick(j):(E||y&&!n(r)||!g&&l(r))&&(w||y&&!l(r)||!k&&n(r))?T&&r.req&&r.aborted&&b.nextTick(j):b.nextTick(j);const C=()=>{u=L,r.removeListener("aborted",j),r.removeListener("complete",h),r.removeListener("abort",j),r.removeListener("request",A),r.req&&r.req.removeListener("finish",h),r.removeListener("end",x),r.removeListener("close",x),r.removeListener("finish",h),r.removeListener("end",R),r.removeListener("error",_),r.removeListener("close",j)};if(p.signal&&!S){const t=()=>{const o=u;C(),o.call(r,new e)};if(p.signal.aborted)b.nextTick(t);else{const e=u;u=o(((...o)=>{p.signal.removeEventListener("abort",t),e.apply(r,o)})),p.signal.addEventListener("abort",t)}}return C}
✄
{"version":3,"file":"event_target.js","names":["errorCodes","EventEmitter","process","inspect","ERR_INVALID_ARG_TYPE","ERR_EVENT_RECURSION","ERR_MISSING_ARGS","ERR_INVALID_THIS","kIsEventTarget","Symbol","for","kIsNodeEventTarget","kMaxEventTargetListeners","kMaxEventTargetListenersWarned","kEvents","kIsBeingDispatched","kStop","kTarget","kHandlers","kWeakHandler","kHybridDispatch","kCreateEvent","kNewListener","kRemoveListener","kIsNodeStyleListener","kTrustEvent","kType","kDefaultPrevented","kCancelable","kTimestamp","kBubbles","kComposed","kPropagationStopped","isTrustedSet","WeakSet","isTrusted","Object","getOwnPropertyDescriptor","has","this","get","isEvent","value","Event","constructor","type","options","arguments","length","cancelable","bubbles","composed","Date","now","add","defineProperty","enumerable","configurable","custom","depth","name","opts","assign","Number","isInteger","defaultPrevented","timeStamp","stopImmediatePropagation","preventDefault","target","currentTarget","srcElement","composedPath","returnValue","eventPhase","AT_TARGET","NONE","cancelBubble","stopPropagation","static","kEnumerableProperty","create","defineProperties","prototype","toStringTag","writable","NodeCustomEvent","super","detail","weakListenersState","objectToWeakListenerMap","weakListeners","FinalizationRegistry","listener","remove","WeakMap","registry","map","Listener","previous","once","capture","passive","isNodeStyleListener","weak","next","undefined","removed","Boolean","callback","WeakRef","register","set","handleEvent","bind","same","deref","unregister","initEventTarget","self","Map","defaultMaxListeners","EventTarget","size","w","Error","count","emitWarning","addEventListener","isEventTarget","signal","validateEventListenerOptions","shouldAddListener","String","aborted","removeEventListener","root","handler","delete","dispatchEvent","event","nodeValue","createEvent","arg","result","call","addCatch","err","emitUncaughtException","initNodeEventTarget","NodeEventTarget","setMaxListeners","n","isNodeEventTarget","getMaxListeners","eventNames","Array","from","keys","listenerCount","off","removeListener","on","addListener","emit","hadListeners","removeAllListeners","clear","obj","promise","then","nextTick","defineEventHandler","emitter","wrappedHandler","eventHandler","args","Reflect","apply","makeEventHandler","EventEmitterMixin","Superclass","MixedEventEmitter","protoProps","getOwnPropertyDescriptors"],"sourceRoot":"/root/frida/build/subprojects/frida-tools/agents/fs/fs_agent.js.p/node_modules/@frida/readable-stream/lib/","sources":[""],"mappings":"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"}
✄
import{codes as e}from"../errors.js";import t from"events";import n from"process";import{inspect as i}from"util";const{ERR_INVALID_ARG_TYPE:r,ERR_EVENT_RECURSION:s,ERR_MISSING_ARGS:o,ERR_INVALID_THIS:a}=e,h=Symbol.for("nodejs.event_target"),l=Symbol("kIsNodeEventTarget"),{kMaxEventTargetListeners:c,kMaxEventTargetListenersWarned:v}=t;export const kEvents=Symbol("kEvents");const d=Symbol("kIsBeingDispatched"),u=Symbol("kStop"),f=Symbol("kTarget"),p=Symbol("khandlers");export const kWeakHandler=Symbol("kWeak");const E=Symbol.for("nodejs.internal.kHybridDispatch");export const kCreateEvent=Symbol("kCreateEvent");export const kNewListener=Symbol("kNewListener");export const kRemoveListener=Symbol("kRemoveListener");const g=Symbol("kIsNodeStyleListener");export const kTrustEvent=Symbol("kTrustEvent");const w=Symbol("type"),m=Symbol("defaultPrevented"),b=Symbol("cancelable"),k=Symbol("timestamp"),y=Symbol("bubbles"),T=Symbol("composed"),L=Symbol("propagationStopped"),S=new WeakSet,x=Object.getOwnPropertyDescriptor({get isTrusted(){return S.has(this)}},"isTrusted").get;function N(e){return"string"==typeof e?.[w]}export class Event{constructor(e,t=null){if(0===arguments.length)throw new o("type");const{cancelable:n,bubbles:i,composed:r}={...t};this[b]=!!n,this[y]=!!i,this[T]=!!r,this[w]=`${e}`,this[m]=!1,this[k]=Date.now(),this[L]=!1,t?.[kTrustEvent]&&S.add(this),Object.defineProperty(this,"isTrusted",{get:x,enumerable:!0,configurable:!1}),this[f]=null,this[d]=!1}[i.custom](e,t){if(!N(this))throw new a("Event");const n=this.constructor.name;if(e<0)return n;const r=Object.assign({},t,{depth:Number.isInteger(t.depth)?t.depth-1:t.depth});return`${n} ${i({type:this[w],defaultPrevented:this[m],cancelable:this[b],timeStamp:this[k]},r)}`}stopImmediatePropagation(){if(!N(this))throw new a("Event");this[u]=!0}preventDefault(){if(!N(this))throw new a("Event");this[m]=!0}get target(){if(!N(this))throw new a("Event");return this[f]}get currentTarget(){if(!N(this))throw new a("Event");return this[f]}get srcElement(){if(!N(this))throw new a("Event");return this[f]}get type(){if(!N(this))throw new a("Event");return this[w]}get cancelable(){if(!N(this))throw new a("Event");return this[b]}get defaultPrevented(){if(!N(this))throw new a("Event");return this[b]&&this[m]}get timeStamp(){if(!N(this))throw new a("Event");return this[k]}composedPath(){if(!N(this))throw new a("Event");return this[d]?[this[f]]:[]}get returnValue(){if(!N(this))throw new a("Event");return!this.defaultPrevented}get bubbles(){if(!N(this))throw new a("Event");return this[y]}get composed(){if(!N(this))throw new a("Event");return this[T]}get eventPhase(){if(!N(this))throw new a("Event");return this[d]?Event.AT_TARGET:Event.NONE}get cancelBubble(){if(!N(this))throw new a("Event");return this[L]}set cancelBubble(e){if(!N(this))throw new a("Event");e&&this.stopPropagation()}stopPropagation(){if(!N(this))throw new a("Event");this[L]=!0}static NONE=0;static CAPTURING_PHASE=1;static AT_TARGET=2;static BUBBLING_PHASE=3}const P=Object.create(null);P.enumerable=!0,Object.defineProperties(Event.prototype,{[Symbol.toStringTag]:{writable:!1,enumerable:!1,configurable:!0,value:"Event"},stopImmediatePropagation:P,preventDefault:P,target:P,currentTarget:P,srcElement:P,type:P,cancelable:P,defaultPrevented:P,timeStamp:P,composedPath:P,returnValue:P,bubbles:P,composed:P,eventPhase:P,cancelBubble:P,stopPropagation:P});class R extends Event{constructor(e,t){super(e,t),t?.detail&&(this.detail=t.detail)}}let I=null,A=null;function M(){return null===I&&(I=new FinalizationRegistry((e=>e.remove()))),null===A&&(A=new WeakMap),{registry:I,map:A}}class O{constructor(e,t,n,i,r,s,o){this.next=void 0,void 0!==e&&(e.next=this),this.previous=e,this.listener=t,this.once=n,this.capture=i,this.passive=r,this.isNodeStyleListener=s,this.removed=!1,this.weak=Boolean(o),this.weak?(this.callback=new WeakRef(t),M().registry.register(t,this,this),M().map.set(o,t),this.listener=this.callback):"function"==typeof t?(this.callback=t,this.listener=t):(this.callback=t.handleEvent.bind(t),this.listener=t)}same(e,t){return(this.weak?this.listener.deref():this.listener)===e&&this.capture===t}remove(){void 0!==this.previous&&(this.previous.next=this.next),void 0!==this.next&&(this.next.previous=this.previous),this.removed=!0,this.weak&&M().registry.unregister(this)}}export function initEventTarget(e){e[kEvents]=new Map,e[c]=t.defaultMaxListeners,e[v]=!1}export class EventTarget{static[h]=!0;constructor(){initEventTarget(this)}[kNewListener](e,t,r,s,o,a){if(this[c]>0&&e>this[c]&&!this[v]){this[v]=!0;const r=new Error(`Possible EventTarget memory leak detected. ${e} ${t} listeners added to ${i(this,{depth:-1})}. Use events.setMaxListeners() to increase limit`);r.name="MaxListenersExceededWarning",r.target=this,r.type=t,r.count=e,n.emitWarning(r)}}[kRemoveListener](e,t,n,i){}addEventListener(e,t,i={}){if(!isEventTarget(this))throw new a("EventTarget");if(arguments.length<2)throw new o("type","listener");const{once:r,capture:s,passive:h,signal:l,isNodeStyleListener:c,weak:v}=function(e){return"boolean"==typeof e?{capture:e}:null===e?{}:{once:Boolean(e.once),capture:Boolean(e.capture),passive:Boolean(e.passive),signal:e.signal,weak:e[kWeakHandler],isNodeStyleListener:Boolean(e[g])}}(i);if(!z(t)){const i=new Error(`addEventListener called with ${t} which has no effect.`);return i.name="AddEventListenerArgumentTypeWarning",i.target=this,i.type=e,void n.emitWarning(i)}if(e=String(e),l){if(l.aborted)return;l.addEventListener("abort",(()=>{this.removeEventListener(e,t,i)}),{once:!0,[kWeakHandler]:this})}let d=this[kEvents].get(e);if(void 0===d)return d={size:1,next:void 0},new O(d,t,r,s,h,c,v),this[kNewListener](d.size,e,t,r,s,h),void this[kEvents].set(e,d);let u=d.next,f=d;for(;void 0!==u&&!u.same(t,s);)f=u,u=u.next;void 0===u&&(new O(f,t,r,s,h,c,v),d.size++,this[kNewListener](d.size,e,t,r,s,h))}removeEventListener(e,t,n={}){if(!isEventTarget(this))throw new a("EventTarget");if(!z(t))return;e=String(e);const i=!0===n?.capture,r=this[kEvents].get(e);if(void 0===r||void 0===r.next)return;let s=r.next;for(;void 0!==s;){if(s.same(t,i)){s.remove(),r.size--,0===r.size&&this[kEvents].delete(e),this[kRemoveListener](r.size,e,t,i);break}s=s.next}}dispatchEvent(e){if(!isEventTarget(this))throw new a("EventTarget");if(!(e instanceof Event))throw new r("event","Event",e);if(e[d])throw new s(e.type);return this[E](e,e.type,e),!0!==e.defaultPrevented}[E](e,t,n){const i=()=>(void 0===n&&((n=this[kCreateEvent](e,t))[f]=this,n[d]=!0),n);void 0!==n&&(n[f]=this,n[d]=!0);const r=this[kEvents].get(t);if(void 0===r||void 0===r.next)return void 0!==n&&(n[d]=!1),!0;let s,o=r.next;for(;void 0!==o&&(o.passive||!0!==n?.[u]);)if(s=o.next,o.removed)o=s;else{if(o.once){o.remove(),r.size--;const{listener:e,capture:n}=o;this[kRemoveListener](r.size,t,e,n)}try{let t;t=o.isNodeStyleListener?e:i();const n=o.weak?o.callback.deref():o.callback;let r;n&&(r=n.call(this,t),o.isNodeStyleListener||(t[d]=!1)),null!=r&&_(r)}catch(e){B(e)}o=s}void 0!==n&&(n[d]=!1)}[kCreateEvent](e,t){return new R(t,{detail:e})}[i.custom](e,t){if(!isEventTarget(this))throw new a("EventTarget");const n=this.constructor.name;if(e<0)return n;const r=Object.assign({},t,{depth:Number.isInteger(t.depth)?t.depth-1:t.depth});return`${n} ${i({},r)}`}}Object.defineProperties(EventTarget.prototype,{addEventListener:P,removeEventListener:P,dispatchEvent:P,[Symbol.toStringTag]:{writable:!1,enumerable:!1,configurable:!0,value:"EventTarget"}});export function initNodeEventTarget(e){initEventTarget(e)}export class NodeEventTarget extends EventTarget{static[l]=!0;static defaultMaxListeners=10;constructor(){super(),initNodeEventTarget(this)}setMaxListeners(e){if(!j(this))throw new a("NodeEventTarget");t.setMaxListeners(e,this)}getMaxListeners(){if(!j(this))throw new a("NodeEventTarget");return this[c]}eventNames(){if(!j(this))throw new a("NodeEventTarget");return Array.from(this[kEvents].keys())}listenerCount(e){if(!j(this))throw new a("NodeEventTarget");const t=this[kEvents].get(String(e));return void 0!==t?t.size:0}off(e,t,n){if(!j(this))throw new a("NodeEventTarget");return this.removeEventListener(e,t,n),this}removeListener(e,t,n){if(!j(this))t
"""


```