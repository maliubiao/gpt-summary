Response:
### 功能归纳

`droidy-host-session.vala` 文件是 Frida 动态插桩工具的一部分，主要负责与 Android 设备上的 Frida 代理进行通信和管理会话。以下是该文件的主要功能：

1. **会话管理**：
   - 管理本地和远程会话的创建、销毁和状态跟踪。
   - 处理会话的分离（detach）事件，并在会话结束时执行清理操作。

2. **Gadget 管理**：
   - 管理 Frida Gadget（一种在目标进程中运行的 Frida 代理）的生命周期。
   - 处理 Gadget 的分离事件，并在 Gadget 关闭时执行清理操作。

3. **DBus 通信**：
   - 通过 DBus 与 Frida 代理进行通信，发送和接收命令、数据。
   - 管理 DBus 连接的打开、关闭和错误处理。

4. **远程服务器管理**：
   - 管理远程服务器的连接和会话，支持常规会话和 Gadget 会话。
   - 提供传输代理（Transport Broker）功能，用于在远程服务器和本地客户端之间传输数据。

5. **错误处理**：
   - 处理会话和连接中的错误，确保在发生错误时能够正确清理资源。

### 涉及二进制底层和 Linux 内核的示例

虽然该文件主要处理会话管理和通信，但 Frida 工具本身涉及到底层二进制插桩和 Linux 内核的交互。例如：

- **二进制插桩**：Frida 通过注入代码到目标进程中，修改其行为。这涉及到对目标进程的内存进行操作，包括读取、写入和执行代码。
- **Linux 内核交互**：Frida 使用 `ptrace` 系统调用来附加到目标进程，并监控其执行。`ptrace` 是 Linux 内核提供的一个系统调用，用于进程调试和监控。

### LLDB 调试示例

假设你想使用 LLDB 调试 Frida 的会话管理功能，以下是一个简单的 LLDB Python 脚本示例，用于设置断点并打印会话状态：

```python
import lldb

def frida_session_breakpoint(frame, bp_loc, dict):
    thread = frame.GetThread()
    process = thread.GetProcess()
    target = process.GetTarget()
    
    # 打印当前会话状态
    session_id = frame.FindVariable("local_session_id").GetValue()
    print(f"Session ID: {session_id}")
    
    # 继续执行
    process.Continue()

def setup_breakpoint(debugger, command, result, internal_dict):
    target = debugger.GetSelectedTarget()
    if not target:
        print("No target selected.")
        return
    
    # 在 GadgetEntry 的 close 方法上设置断点
    breakpoint = target.BreakpointCreateByName("GadgetEntry::close")
    if not breakpoint.IsValid():
        print("Failed to set breakpoint.")
        return
    
    # 设置断点回调
    breakpoint.SetScriptCallbackFunction("frida_session_breakpoint")
    print("Breakpoint set on GadgetEntry::close")

# 注册 LLDB 命令
def __lldb_init_module(debugger, internal_dict):
    debugger.HandleCommand('command script add -f setup_breakpoint.setup_breakpoint frida_breakpoint')
    print("The 'frida_breakpoint' command has been installed.")
```

### 假设输入与输出

假设你运行了上述 LLDB 脚本并附加到一个使用 Frida 的进程，当会话关闭时，脚本会打印出会话的 ID。

**输入**：
- 运行 `frida_breakpoint` 命令设置断点。
- 启动一个 Frida 会话并关闭它。

**输出**：
```
Breakpoint set on GadgetEntry::close
Session ID: 12345
```

### 常见使用错误

1. **会话未正确关闭**：
   - 用户可能在会话结束时忘记调用 `close` 方法，导致资源泄漏。
   - **示例**：用户在使用 Frida 脚本时，未正确处理异常，导致会话未正确关闭。

2. **DBus 连接错误**：
   - 用户可能在 DBus 连接断开后未正确处理重连逻辑，导致会话中断。
   - **示例**：用户在使用 Frida 时，网络不稳定导致 DBus 连接断开，但未处理重连逻辑。

3. **权限不足**：
   - 用户可能没有足够的权限附加到目标进程，导致会话无法启动。
   - **示例**：用户尝试附加到一个系统进程，但没有 root 权限，导致附加失败。

### 用户操作步骤

1. **启动 Frida 服务器**：
   - 用户在目标设备上启动 Frida 服务器。

2. **连接到目标设备**：
   - 用户使用 Frida 客户端连接到目标设备。

3. **创建会话**：
   - 用户创建一个新的会话，并开始与目标进程交互。

4. **调试和插桩**：
   - 用户使用 Frida 脚本对目标进程进行调试和插桩。

5. **关闭会话**：
   - 用户完成调试后，关闭会话并清理资源。

### 调试线索

- **会话状态**：通过打印会话 ID 和状态，可以跟踪会话的生命周期。
- **DBus 连接**：通过监控 DBus 连接的状态，可以诊断连接问题。
- **错误日志**：通过查看错误日志，可以定位权限不足或其他错误。

### 总结

`droidy-host-session.vala` 文件是 Frida 工具中用于管理 Android 设备上会话的核心部分。它负责会话的创建、管理和销毁，并通过 DBus 与 Frida 代理进行通信。通过 LLDB 调试和监控会话状态，可以有效地诊断和解决使用中的问题。
### 提示词
```
这是目录为frida/subprojects/frida-python/subprojects/frida-core/src/droidy/droidy-host-session.vala的frida Dynamic instrumentation tool的源代码文件， 请列举一下它的功能, 
如果涉及到二进制底层，linux内核，请做出对应的举例说明，
请给出用lldb指令或者lldb python脚本，用来复刻的源代码所实现调试功能的示例，如果源代码是调试功能的实现。
如果做了逻辑推理，请给出假设输入与输出,
如果涉及用户或者编程常见的使用错误，请举例说明,
说明用户操作是如何一步步的到达这里，作为调试线索，
请用中文回复。
这是第5部分，共5部分，请归纳一下它的功能
```

### 源代码
```
0x63, 0x68, 0x65, 0x72, 0x50, 0x61, 0x63, 0x6b,
			0x61, 0x67, 0x65, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x04, 0x64, 0x72, 0x61, 0x77, 0x00, 0x16, 0x65, 0x6e, 0x75, 0x6d,
			0x65, 0x72, 0x61, 0x74, 0x65, 0x2d, 0x61, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x73, 0x00,
			0x13, 0x65, 0x6e, 0x75, 0x6d, 0x65, 0x72, 0x61, 0x74, 0x65, 0x2d, 0x70, 0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x65,
			0x73, 0x00, 0x15, 0x65, 0x6e, 0x75, 0x6d, 0x65, 0x72, 0x61, 0x74, 0x65, 0x41, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61,
			0x74, 0x69, 0x6f, 0x6e, 0x73, 0x00, 0x12, 0x65, 0x6e, 0x75, 0x6d, 0x65, 0x72, 0x61, 0x74, 0x65, 0x50, 0x72, 0x6f,
			0x63, 0x65, 0x73, 0x73, 0x65, 0x73, 0x00, 0x06, 0x65, 0x71, 0x75, 0x61, 0x6c, 0x73, 0x00, 0x03, 0x65, 0x72, 0x72,
			0x00, 0x03, 0x65, 0x78, 0x65, 0x00, 0x04, 0x65, 0x78, 0x69, 0x74, 0x00, 0x0c, 0x66, 0x65, 0x74, 0x63, 0x68, 0x41,
			0x70, 0x70, 0x49, 0x63, 0x6f, 0x6e, 0x00, 0x12, 0x66, 0x65, 0x74, 0x63, 0x68, 0x41, 0x70, 0x70, 0x50, 0x61, 0x72,
			0x61, 0x6d, 0x65, 0x74, 0x65, 0x72, 0x73, 0x00, 0x0f, 0x66, 0x65, 0x74, 0x63, 0x68, 0x41, 0x70, 0x70, 0x53, 0x6f,
			0x75, 0x72, 0x63, 0x65, 0x73, 0x00, 0x04, 0x66, 0x69, 0x6e, 0x64, 0x00, 0x05, 0x66, 0x6c, 0x61, 0x67, 0x73, 0x00,
			0x05, 0x66, 0x6c, 0x75, 0x73, 0x68, 0x00, 0x07, 0x66, 0x6f, 0x72, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x06, 0x66, 0x6f,
			0x72, 0x6d, 0x61, 0x74, 0x00, 0x09, 0x66, 0x72, 0x6f, 0x6e, 0x74, 0x6d, 0x6f, 0x73, 0x74, 0x00, 0x03, 0x67, 0x65,
			0x74, 0x00, 0x19, 0x67, 0x65, 0x74, 0x2d, 0x66, 0x72, 0x6f, 0x6e, 0x74, 0x6d, 0x6f, 0x73, 0x74, 0x2d, 0x61, 0x70,
			0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x00, 0x0f, 0x67, 0x65, 0x74, 0x41, 0x62, 0x73, 0x6f, 0x6c,
			0x75, 0x74, 0x65, 0x50, 0x61, 0x74, 0x68, 0x00, 0x0f, 0x67, 0x65, 0x74, 0x41, 0x70, 0x70, 0x50, 0x72, 0x6f, 0x63,
			0x65, 0x73, 0x73, 0x65, 0x73, 0x00, 0x12, 0x67, 0x65, 0x74, 0x41, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69,
			0x6f, 0x6e, 0x49, 0x63, 0x6f, 0x6e, 0x00, 0x12, 0x67, 0x65, 0x74, 0x41, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74,
			0x69, 0x6f, 0x6e, 0x49, 0x6e, 0x66, 0x6f, 0x00, 0x08, 0x67, 0x65, 0x74, 0x42, 0x79, 0x74, 0x65, 0x73, 0x00, 0x08,
			0x67, 0x65, 0x74, 0x43, 0x61, 0x75, 0x73, 0x65, 0x00, 0x10, 0x67, 0x65, 0x74, 0x44, 0x65, 0x63, 0x6c, 0x61, 0x72,
			0x65, 0x64, 0x46, 0x69, 0x65, 0x6c, 0x64, 0x00, 0x11, 0x67, 0x65, 0x74, 0x44, 0x65, 0x63, 0x6c, 0x61, 0x72, 0x65,
			0x64, 0x4d, 0x65, 0x74, 0x68, 0x6f, 0x64, 0x00, 0x17, 0x67, 0x65, 0x74, 0x46, 0x69, 0x6c, 0x65, 0x43, 0x6f, 0x6e,
			0x74, 0x65, 0x6e, 0x74, 0x73, 0x41, 0x73, 0x53, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x00, 0x17, 0x67, 0x65, 0x74, 0x46,
			0x72, 0x6f, 0x6e, 0x74, 0x6d, 0x6f, 0x73, 0x74, 0x41, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e,
			0x00, 0x17, 0x67, 0x65, 0x74, 0x46, 0x72, 0x6f, 0x6e, 0x74, 0x6d, 0x6f, 0x73, 0x74, 0x50, 0x61, 0x63, 0x6b, 0x61,
			0x67, 0x65, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x0e, 0x67, 0x65, 0x74, 0x49, 0x6e, 0x70, 0x75, 0x74, 0x53, 0x74, 0x72,
			0x65, 0x61, 0x6d, 0x00, 0x06, 0x67, 0x65, 0x74, 0x49, 0x6e, 0x74, 0x00, 0x12, 0x67, 0x65, 0x74, 0x49, 0x6e, 0x74,
			0x72, 0x69, 0x6e, 0x73, 0x69, 0x63, 0x48, 0x65, 0x69, 0x67, 0x68, 0x74, 0x00, 0x11, 0x67, 0x65, 0x74, 0x49, 0x6e,
			0x74, 0x72, 0x69, 0x6e, 0x73, 0x69, 0x63, 0x57, 0x69, 0x64, 0x74, 0x68, 0x00, 0x0c, 0x67, 0x65, 0x74, 0x4a, 0x53,
			0x4f, 0x4e, 0x41, 0x72, 0x72, 0x61, 0x79, 0x00, 0x17, 0x67, 0x65, 0x74, 0x4c, 0x61, 0x75, 0x6e, 0x63, 0x68, 0x65,
			0x72, 0x41, 0x70, 0x70, 0x6c, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x73, 0x00, 0x07, 0x67, 0x65, 0x74, 0x4e,
			0x61, 0x6d, 0x65, 0x00, 0x0f, 0x67, 0x65, 0x74, 0x4f, 0x75, 0x74, 0x70, 0x75, 0x74, 0x53, 0x74, 0x72, 0x65, 0x61,
			0x6d, 0x00, 0x0e, 0x67, 0x65, 0x74, 0x50, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x49, 0x6e, 0x66, 0x6f, 0x00, 0x11,
			0x67, 0x65, 0x74, 0x50, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x4d, 0x61, 0x6e, 0x61, 0x67, 0x65, 0x72, 0x00, 0x0e,
			0x67, 0x65, 0x74, 0x50, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x16, 0x67, 0x65, 0x74,
			0x52, 0x75, 0x6e, 0x6e, 0x69, 0x6e, 0x67, 0x41, 0x70, 0x70, 0x50, 0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x65, 0x73,
			0x00, 0x0f, 0x67, 0x65, 0x74, 0x52, 0x75, 0x6e, 0x6e, 0x69, 0x6e, 0x67, 0x54, 0x61, 0x73, 0x6b, 0x73, 0x00, 0x09,
			0x67, 0x65, 0x74, 0x53, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x00, 0x10, 0x67, 0x65, 0x74, 0x53, 0x79, 0x73, 0x74, 0x65,
			0x6d, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x78, 0x74, 0x00, 0x10, 0x67, 0x65, 0x74, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6d,
			0x53, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x00, 0x0b, 0x67, 0x65, 0x74, 0x54, 0x69, 0x6d, 0x65, 0x5a, 0x6f, 0x6e,
			0x65, 0x00, 0x08, 0x67, 0x65, 0x74, 0x70, 0x77, 0x75, 0x69, 0x64, 0x00, 0x05, 0x67, 0x72, 0x6f, 0x75, 0x70, 0x00,
			0x10, 0x68, 0x61, 0x6e, 0x64, 0x6c, 0x65, 0x43, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x00, 0x19,
			0x68, 0x61, 0x6e, 0x64, 0x6c, 0x65, 0x49, 0x6e, 0x63, 0x6f, 0x6d, 0x69, 0x6e, 0x67, 0x43, 0x6f, 0x6e, 0x6e, 0x65,
			0x63, 0x74, 0x69, 0x6f, 0x6e, 0x73, 0x00, 0x07, 0x68, 0x61, 0x73, 0x4e, 0x65, 0x78, 0x74, 0x00, 0x0a, 0x69, 0x6d,
			0x70, 0x6f, 0x72, 0x74, 0x61, 0x6e, 0x63, 0x65, 0x00, 0x07, 0x69, 0x6e, 0x64, 0x65, 0x78, 0x4f, 0x66, 0x00, 0x08,
			0x69, 0x6e, 0x74, 0x56, 0x61, 0x6c, 0x75, 0x65, 0x00, 0x06, 0x69, 0x6e, 0x76, 0x6f, 0x6b, 0x65, 0x00, 0x0b, 0x69,
			0x73, 0x44, 0x69, 0x72, 0x65, 0x63, 0x74, 0x6f, 0x72, 0x79, 0x00, 0x07, 0x69, 0x73, 0x45, 0x6d, 0x70, 0x74, 0x79,
			0x00, 0x08, 0x69, 0x74, 0x65, 0x72, 0x61, 0x74, 0x6f, 0x72, 0x00, 0x06, 0x6c, 0x65, 0x6e, 0x67, 0x74, 0x68, 0x00,
			0x09, 0x6c, 0x69, 0x73, 0x74, 0x46, 0x69, 0x6c, 0x65, 0x73, 0x00, 0x09, 0x6c, 0x6f, 0x61, 0x64, 0x4c, 0x61, 0x62,
			0x65, 0x6c, 0x00, 0x04, 0x6c, 0x6f, 0x6f, 0x70, 0x00, 0x10, 0x6d, 0x41, 0x63, 0x74, 0x69, 0x76, 0x69, 0x74, 0x79,
			0x4d, 0x61, 0x6e, 0x61, 0x67, 0x65, 0x72, 0x00, 0x09, 0x6d, 0x47, 0x65, 0x74, 0x70, 0x77, 0x75, 0x69, 0x64, 0x00,
			0x08, 0x6d, 0x49, 0x73, 0x6f, 0x38, 0x36, 0x30, 0x31, 0x00, 0x10, 0x6d, 0x4c, 0x61, 0x75, 0x6e, 0x63, 0x68, 0x65,
			0x72, 0x50, 0x6b, 0x67, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x15, 0x6d, 0x4d, 0x69, 0x6c, 0x6c, 0x69, 0x73, 0x65, 0x63,
			0x6f, 0x6e, 0x64, 0x73, 0x50, 0x65, 0x72, 0x4a, 0x69, 0x66, 0x66, 0x79, 0x00, 0x0f, 0x6d, 0x50, 0x61, 0x63, 0x6b,
			0x61, 0x67, 0x65, 0x4d, 0x61, 0x6e, 0x61, 0x67, 0x65, 0x72, 0x00, 0x0c, 0x6d, 0x50, 0x77, 0x6e, 0x61, 0x6d, 0x65,
			0x46, 0x69, 0x65, 0x6c, 0x64, 0x00, 0x07, 0x6d, 0x53, 0x6f, 0x63, 0x6b, 0x65, 0x74, 0x00, 0x0f, 0x6d, 0x53, 0x79,
			0x73, 0x74, 0x65, 0x6d, 0x42, 0x6f, 0x6f, 0x74, 0x54, 0x69, 0x6d, 0x65, 0x00, 0x11, 0x6d, 0x54, 0x6f, 0x70, 0x41,
			0x63, 0x74, 0x69, 0x76, 0x69, 0x74, 0x79, 0x46, 0x69, 0x65, 0x6c, 0x64, 0x00, 0x07, 0x6d, 0x57, 0x6f, 0x72, 0x6b,
			0x65, 0x72, 0x00, 0x04, 0x6d, 0x61, 0x69, 0x6e, 0x00, 0x07, 0x6d, 0x61, 0x74, 0x63, 0x68, 0x65, 0x72, 0x00, 0x05,
			0x6d, 0x79, 0x50, 0x69, 0x64, 0x00, 0x04, 0x6e, 0x61, 0x6d, 0x65, 0x00, 0x04, 0x6e, 0x65, 0x78, 0x74, 0x00, 0x03,
			0x6f, 0x75, 0x74, 0x00, 0x0b, 0x70, 0x61, 0x63, 0x6b, 0x61, 0x67, 0x65, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x08, 0x70,
			0x61, 0x72, 0x73, 0x65, 0x49, 0x6e, 0x74, 0x00, 0x09, 0x70, 0x61, 0x72, 0x73, 0x65, 0x4c, 0x6f, 0x6e, 0x67, 0x00,
			0x04, 0x70, 0x61, 0x74, 0x68, 0x00, 0x03, 0x70, 0x69, 0x64, 0x00, 0x07, 0x70, 0x6b, 0x67, 0x4c, 0x69, 0x73, 0x74,
			0x00, 0x04, 0x70, 0x70, 0x69, 0x64, 0x00, 0x07, 0x70, 0x72, 0x65, 0x70, 0x61, 0x72, 0x65, 0x00, 0x07, 0x70, 0x72,
			0x69, 0x6e, 0x74, 0x6c, 0x6e, 0x00, 0x0f, 0x70, 0x75, 0x62, 0x6c, 0x69, 0x63, 0x53, 0x6f, 0x75, 0x72, 0x63, 0x65,
			0x44, 0x69, 0x72, 0x00, 0x03, 0x70, 0x75, 0x74, 0x00, 0x07, 0x70, 0x77, 0x5f, 0x6e, 0x61, 0x6d, 0x65, 0x00, 0x15,
			0x71, 0x75, 0x65, 0x72, 0x79, 0x49, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x41, 0x63, 0x74, 0x69, 0x76, 0x69, 0x74, 0x69,
			0x65, 0x73, 0x00, 0x13, 0x71, 0x75, 0x65, 0x72, 0x79, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6d, 0x42, 0x6f, 0x6f, 0x74,
			0x54, 0x69, 0x6d, 0x65, 0x00, 0x04, 0x72, 0x65, 0x61, 0x64, 0x00, 0x09, 0x72, 0x65, 0x61, 0x64, 0x46, 0x75, 0x6c,
			0x6c, 0x79, 0x00, 0x07, 0x72, 0x65, 0x61, 0x64, 0x49, 0x6e, 0x74, 0x00, 0x08, 0x72, 0x65, 0x61, 0x64, 0x6c, 0x69,
			0x6e, 0x6b, 0x00, 0x13, 0x72, 0x65, 0x73, 0x6f, 0x6c, 0x76, 0x65, 0x55, 0x73, 0x65, 0x72, 0x49, 0x64, 0x54, 0x6f,
			0x4e, 0x61, 0x6d, 0x65, 0x00, 0x03, 0x72, 0x75, 0x6e, 0x00, 0x11, 0x73, 0x53, 0x74, 0x61, 0x74, 0x75, 0x73, 0x55,
			0x69, 0x64, 0x50, 0x61, 0x74, 0x74, 0x65, 0x72, 0x6e, 0x00, 0x09, 0x73, 0x65, 0x74, 0x42, 0x6f, 0x75, 0x6e, 0x64,
			0x73, 0x00, 0x0b, 0x73, 0x65, 0x74, 0x54, 0x69, 0x6d, 0x65, 0x5a, 0x6f, 0x6e, 0x65, 0x00, 0x04, 0x73, 0x69, 0x7a,
			0x65, 0x00, 0x04, 0x73, 0x6f, 0x72, 0x74, 0x00, 0x07, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x73, 0x00, 0x05, 0x73,
			0x70, 0x6c, 0x69, 0x74, 0x00, 0x15, 0x73, 0x70, 0x6c, 0x69, 0x74, 0x50, 0x75, 0x62, 0x6c, 0x69, 0x63, 0x53, 0x6f,
			0x75, 0x72, 0x63, 0x65, 0x44, 0x69, 0x72, 0x73, 0x00, 0x05, 0x73, 0x74, 0x61, 0x72, 0x74, 0x00, 0x07, 0x73, 0x74,
			0x61, 0x72, 0x74, 0x65, 0x64, 0x00, 0x04, 0x73, 0x74, 0x61, 0x74, 0x00, 0x06, 0x73, 0x74, 0x61, 0x74, 0x75, 0x73,
			0x00, 0x09, 0x73, 0x75, 0x62, 0x73, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x00, 0x07, 0x73, 0x79, 0x73, 0x63, 0x6f, 0x6e,
			0x66, 0x00, 0x0a, 0x73, 0x79, 0x73, 0x74, 0x65, 0x6d, 0x4d, 0x61, 0x69, 0x6e, 0x00, 0x0a, 0x74, 0x61, 0x72, 0x67,
			0x65, 0x74, 0x2d, 0x73, 0x64, 0x6b, 0x00, 0x10, 0x74, 0x61, 0x72, 0x67, 0x65, 0x74, 0x53, 0x64, 0x6b, 0x56, 0x65,
			0x72, 0x73, 0x69, 0x6f, 0x6e, 0x00, 0x06, 0x74, 0x68, 0x69, 0x73, 0x24, 0x30, 0x00, 0x08, 0x74, 0x6f, 0x53, 0x74,
			0x72, 0x69, 0x6e, 0x67, 0x00, 0x0b, 0x74, 0x6f, 0x55, 0x70, 0x70, 0x65, 0x72, 0x43, 0x61, 0x73, 0x65, 0x00, 0x0b,
			0x74, 0x6f, 0x70, 0x41, 0x63, 0x74, 0x69, 0x76, 0x69, 0x74, 0x79, 0x00, 0x04, 0x75, 0x73, 0x65, 0x72, 0x00, 0x0a,
			0x76, 0x61, 0x6c, 0x24, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x00, 0x05, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x00, 0x07,
			0x76, 0x61, 0x6c, 0x75, 0x65, 0x4f, 0x66, 0x00, 0x06, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x73, 0x00, 0x07, 0x76, 0x65,
			0x72, 0x73, 0x69, 0x6f, 0x6e, 0x00, 0x0b, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x43, 0x6f, 0x64, 0x65, 0x00,
			0x0b, 0x76, 0x65, 0x72, 0x73, 0x69, 0x6f, 0x6e, 0x4e, 0x61, 0x6d, 0x65, 0x00, 0x05, 0x77, 0x72, 0x69, 0x74, 0x65,
			0x00, 0x08, 0x77, 0x72, 0x69, 0x74, 0x65, 0x49, 0x6e, 0x74, 0x00, 0x1c, 0x79, 0x79, 0x79, 0x79, 0x2d, 0x4d, 0x4d,
			0x2d, 0x64, 0x64, 0x27, 0x54, 0x27, 0x48, 0x48, 0x3a, 0x6d, 0x6d, 0x3a, 0x73, 0x73, 0x2e, 0x53, 0x53, 0x53, 0x27,
			0x5a, 0x27, 0x00, 0x8c, 0x01, 0x02, 0x00, 0x00, 0x07, 0x0e, 0x00, 0x8e, 0x01, 0x00, 0x07, 0x0e, 0x5a, 0x00, 0x9e,
			0x01, 0x03, 0x00, 0x00, 0x00, 0x07, 0x0e, 0x00, 0xa0, 0x01, 0x00, 0x07, 0x0e, 0x78, 0x00, 0xd2, 0x04, 0x01, 0x00,
			0x07, 0x0e, 0x00, 0xd5, 0x04, 0x02, 0x00, 0x00, 0x07, 0x0e, 0x00, 0xd2, 0x04, 0x02, 0x00, 0x00, 0x07, 0x0e, 0x00,
			0x6b, 0x00, 0x07, 0x0e, 0x00, 0x77, 0x02, 0x00, 0x00, 0x07, 0x0e, 0x39, 0x4d, 0x69, 0xa7, 0xe3, 0x69, 0x69, 0xb4,
			0xb4, 0xb5, 0x01, 0x16, 0x0f, 0xe5, 0x2d, 0x9a, 0x02, 0x76, 0x1d, 0x1e, 0x02, 0x75, 0x68, 0x00, 0x3d, 0x01, 0x00,
			0x07, 0x0e, 0x00, 0xe9, 0x04, 0x02, 0x00, 0x00, 0x07, 0x1d, 0x01, 0x1c, 0x10, 0xb4, 0x69, 0x3c, 0x88, 0xb4, 0x69,
			0x2d, 0xa7, 0x6a, 0x87, 0x3c, 0x89, 0x96, 0x5a, 0xb7, 0x1a, 0x1e, 0x00, 0xe0, 0x04, 0x01, 0x00, 0x07, 0x0e, 0x0f,
			0x69, 0x3c, 0x5b, 0x00, 0x9b, 0x05, 0x00, 0x07, 0x1d, 0x78, 0x5b, 0x69, 0x69, 0x20, 0x00, 0x93, 0x02, 0x01, 0x00,
			0x07, 0x3b, 0x4b, 0xd4, 0x4b, 0x2d, 0x69, 0x2d, 0x4c, 0xa1, 0x43, 0x4d, 0x5b, 0x4b, 0x97, 0xff, 0x2e, 0x6b, 0x69,
			0x2d, 0x8a, 0x4c, 0x4f, 0x2e, 0x41, 0x87, 0x5d, 0x5a, 0x3c, 0x3c, 0x3c, 0x3d, 0x02, 0x58, 0x59, 0x02, 0x18, 0x1d,
			0x2d, 0x02, 0x78, 0x1d, 0x02, 0x1a, 0x2c, 0x02, 0x4b, 0x1d, 0x00, 0xd7, 0x02, 0x01, 0x00, 0x07, 0x0e, 0x78, 0xf1,
			0x4b, 0x5a, 0x2d, 0x3c, 0xb2, 0x3f, 0x4c, 0x01, 0x11, 0x0f, 0x67, 0x42, 0x8b, 0x30, 0x8a, 0x5b, 0x4c, 0x5a, 0x01,
			0x14, 0x0f, 0xff, 0xa8, 0x5a, 0x01, 0x14, 0x0f, 0x6b, 0x5a, 0x01, 0x14, 0x0f, 0x78, 0x96, 0x69, 0x2d, 0xa1, 0x53,
			0x1e, 0x4b, 0x4b, 0x2d, 0x69, 0x2d, 0xa9, 0xff, 0xb5, 0x6b, 0x2d, 0x02, 0x11, 0x95, 0x1e, 0x4b, 0x5c, 0x01, 0x14,
			0x0f, 0x9a, 0x9a, 0x69, 0x2d, 0x5a, 0x87, 0x3a, 0x02, 0x60, 0x3b, 0xb8, 0x4b, 0x30, 0x02, 0x19, 0x68, 0x5c, 0x69,
			0x5a, 0x96, 0x5c, 0x69, 0x7b, 0x5a, 0x3c, 0x3c, 0x3d, 0x5c, 0x02, 0x60, 0x1d, 0x02, 0x7b, 0x3b, 0x02, 0x6d, 0x2c,
			0x02, 0x41, 0x3b, 0x00, 0xb6, 0x04, 0x01, 0x00, 0x07, 0x1d, 0x6a, 0x4b, 0x4c, 0x69, 0x5a, 0x3c, 0x3d, 0x5a, 0xd3,
			0x00, 0x8f, 0x04, 0x02, 0x00, 0x00, 0x07, 0x0e, 0x5b, 0x98, 0x78, 0xb4, 0x96, 0x78, 0x78, 0x69, 0x6b, 0x4b, 0x5a,
			0x78, 0x5f, 0x19, 0x1e, 0x00, 0xaa, 0x04, 0x01, 0x00, 0x07, 0x0e, 0x5a, 0x5a, 0x2d, 0x2d, 0x69, 0x3a, 0x3f, 0x00,
			0xc7, 0x04, 0x00, 0x07, 0x0e, 0x5b, 0x01, 0x16, 0x0f, 0x96, 0x69, 0x2d, 0x5a, 0x3d, 0x3c, 0x78, 0x02, 0x78, 0x86,
			0x02, 0x12, 0x4a, 0x00, 0xa7, 0x05, 0x01, 0x00, 0x07, 0x0e, 0x5b, 0x5b, 0x4c, 0x4b, 0x41, 0x3e, 0x02, 0x7a, 0x59,
			0x5c, 0x4b, 0x00, 0xe2, 0x01, 0x01, 0x00, 0x07, 0x2c, 0xd3, 0x4b, 0x02, 0x2a, 0x2c, 0x02, 0x5c, 0x1d, 0x7c, 0x6b,
			0xa5, 0x2d, 0x8a, 0x4c, 0x4f, 0x2e, 0x42, 0x5a, 0x3c, 0x3c, 0x3c, 0x02, 0x6f, 0x4a, 0x33, 0x02, 0x69, 0x2c, 0x00,
			0xe7, 0x03, 0x00, 0x07, 0x1d, 0x02, 0x17, 0x59, 0x02, 0x6d, 0x1d, 0x78, 0x78, 0x20, 0x7b, 0x8b, 0x4b, 0x96, 0x02,
			0x7a, 0x1d, 0x1e, 0x00, 0x82, 0x04, 0x00, 0x07, 0x0e, 0x5b, 0x78, 0x5b, 0x01, 0x17, 0x0f, 0x89, 0x00, 0x99, 0x01,
			0x00, 0x07, 0x0e, 0x7b, 0x69, 0x7c, 0x4b, 0x21, 0x00, 0x3f, 0x01, 0x00, 0x07, 0x2c, 0x3c, 0x78, 0x02, 0x23, 0x3b,
			0x02, 0x61, 0x1d, 0x2e, 0x01, 0x21, 0x12, 0x01, 0x18, 0x15, 0x3f, 0x69, 0x01, 0x11, 0x0f, 0x02, 0x0b, 0x01, 0x12,
			0x0e, 0x02, 0x69, 0x95, 0x1e, 0x5a, 0x02, 0x0b, 0x59, 0x1e, 0x96, 0x5b, 0x1e, 0x5a, 0x00, 0x88, 0x05, 0x00, 0x07,
			0x0e, 0xb8, 0xc3, 0x3c, 0x02, 0x7a, 0xd1, 0x1e, 0x00, 0x94, 0x05, 0x01, 0x00, 0x07, 0x0e, 0x01, 0x1a, 0x0f, 0x1e,
			0x67, 0x00, 0x94, 0x01, 0x00, 0x07, 0x0e, 0x5a, 0x3c, 0x00, 0xae, 0x01, 0x01, 0x00, 0x07, 0x0e, 0xe1, 0xe7, 0x4b,
			0x02, 0x25, 0x77, 0x3e, 0x02, 0x5c, 0x1d, 0x2d, 0x3d, 0xa7, 0x5a, 0x87, 0x53, 0x2d, 0x88, 0x4b, 0x3c, 0x4b, 0x02,
			0x72, 0x2c, 0x87, 0x5a, 0x87, 0x60, 0x02, 0x0f, 0xb3, 0x02, 0x79, 0x2c, 0x2a, 0x02, 0x5c, 0x2c, 0x00, 0xbb, 0x05,
			0x00, 0x07, 0x0e, 0x00, 0xbc, 0x05, 0x00, 0x07, 0x0e, 0xa5, 0xa5, 0xa1, 0x00, 0xbb, 0x05, 0x02, 0x00, 0x00, 0x07,
			0x0e, 0x00, 0xbb, 0x05, 0x01, 0x00, 0x07, 0x0e, 0x00, 0xbb, 0x05, 0x00, 0x07, 0x0e, 0x00, 0x02, 0x1b, 0x01, 0xb7,
			0x02, 0x1a, 0x85, 0x02, 0x1c, 0x02, 0x9d, 0x01, 0x04, 0x00, 0x89, 0x02, 0x1e, 0x02, 0x1b, 0x01, 0xb7, 0x02, 0x1a,
			0x95, 0x02, 0x1b, 0x01, 0xb7, 0x02, 0x1a, 0x8f, 0x02, 0x1d, 0x01, 0xb7, 0x02, 0x1c, 0x05, 0x17, 0x59, 0x17, 0x67,
			0x17, 0x0d, 0x17, 0x26, 0x17, 0x10, 0x02, 0x1e, 0x01, 0xb7, 0x02, 0x1c, 0x01, 0x18, 0x4d, 0x02, 0x1d, 0x01, 0xb7,
			0x02, 0x1c, 0x05, 0x17, 0x05, 0x17, 0x6c, 0x17, 0x0d, 0x17, 0x2d, 0x17, 0x10, 0x02, 0x1e, 0x01, 0xb7, 0x02, 0x1c,
			0x01, 0x18, 0x0b, 0x02, 0x1d, 0x01, 0xb7, 0x02, 0x1c, 0x08, 0x17, 0x05, 0x17, 0x6f, 0x17, 0x0d, 0x17, 0x5b, 0x17,
			0x6c, 0x17, 0x0d, 0x17, 0x26, 0x17, 0x11, 0x02, 0x1e, 0x01, 0xb7, 0x02, 0x1c, 0x01, 0x18, 0x27, 0x02, 0x1d, 0x01,
			0xb7, 0x02, 0x1c, 0x04, 0x17, 0x51, 0x17, 0x0d, 0x17, 0x7b, 0x17, 0x10, 0x02, 0x1d, 0x01, 0xb7, 0x02, 0x1c, 0x01,
			0x17, 0x06, 0x00, 0x01, 0x01, 0x01, 0x16, 0x90, 0x20, 0x7d, 0x80, 0x80, 0x04, 0x88, 0x25, 0x7e, 0x01, 0xa4, 0x25,
			0x00, 0x02, 0x01, 0x01, 0x17, 0x90, 0x20, 0x01, 0x90, 0x20, 0x7f, 0x80, 0x80, 0x04, 0xc0, 0x25, 0x80, 0x01, 0x01,
			0xe0, 0x25, 0x00, 0x01, 0x01, 0x02, 0x19, 0x90, 0x20, 0x81, 0x01, 0x80, 0x80, 0x04, 0x80, 0x26, 0x82, 0x01, 0x01,
			0x9c, 0x26, 0x01, 0xc1, 0x20, 0xb8, 0x26, 0x01, 0x0c, 0x15, 0x01, 0x26, 0x0a, 0x1a, 0x12, 0x01, 0x02, 0x01, 0x02,
			0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x01, 0x02, 0x84,
			0x01, 0x88, 0x80, 0x04, 0xdc, 0x26, 0x01, 0x81, 0x80, 0x04, 0x84, 0x27, 0x01, 0x88, 0x20, 0xc8, 0x29, 0x01, 0x02,
			0xe0, 0x29, 0x01, 0x0a, 0xa0, 0x2c, 0x01, 0x02, 0xe0, 0x2c, 0x01, 0x02, 0xbc, 0x2d, 0x01, 0x02, 0xd0, 0x30, 0x01,
			0x02, 0x80, 0x39, 0x01, 0x02, 0x80, 0x3a, 0x01, 0x0a, 0xdc, 0x3b, 0x01, 0x02, 0xa4, 0x3c, 0x01, 0x0a, 0xcc, 0x3d,
			0x01, 0x02, 0xc0, 0x3e, 0x01, 0x02, 0xb4, 0x40, 0x01, 0x02, 0xc4, 0x41, 0x02, 0x02, 0xb8, 0x42, 0x01, 0x09, 0x88,
			0x43, 0x01, 0x0a, 0x80, 0x46, 0x01, 0x02, 0xf8, 0x46, 0x01, 0x02, 0xe4, 0x47, 0x94, 0x01, 0x04, 0x88, 0x48, 0x04,
			0x00, 0x05, 0x00, 0x27, 0x9a, 0x20, 0x01, 0x99, 0x80, 0x01, 0x01, 0x99, 0x80, 0x01, 0x01, 0x99, 0x80, 0x01, 0x9a,
			0x01, 0x8a, 0x20, 0xec, 0x4a, 0x01, 0x88, 0x80, 0x04, 0xa4, 0x4b, 0x01, 0x82, 0x80, 0x04, 0x80, 0x4c, 0x01, 0x09,
			0x98, 0x4c, 0x01, 0x09, 0xbc, 0x4c, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
			0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x40, 0x01, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x02, 0x00,
			0x00, 0x00, 0x5c, 0x00, 0x00, 0x00, 0x70, 0x05, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x5c, 0x00, 0x00, 0x00, 0xe0,
			0x06, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x2b, 0x00, 0x00, 0x00, 0x30, 0x0b, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00,
			0xa0, 0x00, 0x00, 0x00, 0x88, 0x0c, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x88, 0x11, 0x00,
			0x00, 0x03, 0x10, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x28, 0x12, 0x00, 0x00, 0x01, 0x20, 0x00, 0x00, 0x22, 0x00,
			0x00, 0x00, 0x88, 0x12, 0x00, 0x00, 0x06, 0x20, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x60, 0x26, 0x00, 0x00, 0x01,
			0x10, 0x00, 0x00, 0x2d, 0x00, 0x00, 0x00, 0xf8, 0x26, 0x00, 0x00, 0x02, 0x20, 0x00, 0x00, 0x40, 0x01, 0x00, 0x00,
			0x72, 0x28, 0x00, 0x00, 0x03, 0x20, 0x00, 0x00, 0x22, 0x00, 0x00, 0x00, 0x80, 0x3c, 0x00, 0x00, 0x04, 0x20, 0x00,
			0x00, 0x0c, 0x00, 0x00, 0x00, 0xff, 0x3e, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x8a, 0x3f,
			0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x74, 0x40, 0x00, 0x00
		};

		private class GadgetEntry : Object {
			public signal void detached (SessionDetachReason reason);

			public AgentSessionId local_session_id {
				get;
				construct;
			}

			public HostSession host_session {
				get;
				construct;
			}

			public DBusConnection connection {
				get;
				construct;
			}

			private Promise<bool>? close_request;

			public GadgetEntry (AgentSessionId local_session_id, HostSession host_session, DBusConnection connection) {
				Object (
					local_session_id: local_session_id,
					host_session: host_session,
					connection: connection
				);
			}

			construct {
				connection.on_closed.connect (on_connection_closed);
				host_session.agent_session_detached.connect (on_session_detached);
			}

			~GadgetEntry () {
				connection.on_closed.disconnect (on_connection_closed);
				host_session.agent_session_detached.disconnect (on_session_detached);
			}

			public async void close (Cancellable? cancellable) throws IOError {
				while (close_request != null) {
					try {
						yield close_request.future.wait_async (cancellable);
						return;
					} catch (Error e) {
						assert_not_reached ();
					} catch (IOError e) {
						cancellable.set_error_if_cancelled ();
					}
				}
				close_request = new Promise<bool> ();

				try {
					yield connection.close (cancellable);
				} catch (GLib.Error e) {
					if (e is IOError.CANCELLED) {
						close_request.reject (e);
						close_request = null;

						throw (IOError) e;
					}
				}

				close_request.resolve (true);
			}

			private void on_connection_closed (DBusConnection connection, bool remote_peer_vanished, GLib.Error? error) {
				if (close_request == null) {
					close_request = new Promise<bool> ();
					close_request.resolve (true);
				}

				detached (PROCESS_TERMINATED);
			}

			private void on_session_detached (AgentSessionId id, SessionDetachReason reason) {
				detached (reason);
			}
		}

		private class AgentSessionEntry {
			public AgentSessionId remote_session_id {
				get;
				private set;
			}

			public DBusConnection connection {
				get;
				set;
			}

			public uint sink_registration_id {
				get;
				set;
			}

			public AgentSessionEntry (AgentSessionId remote_session_id, DBusConnection connection) {
				this.remote_session_id = remote_session_id;
				this.connection = connection;
			}

			~AgentSessionEntry () {
				if (sink_registration_id != 0)
					connection.unregister_object (sink_registration_id);
			}
		}

		private class RemoteServer : Object {
			public HostSession session {
				get;
				construct;
			}

			public DBusConnection connection {
				get;
				construct;
			}

			public Flavor flavor {
				get;
				construct;
			}

			public enum Flavor {
				REGULAR,
				GADGET
			}

			public TransportBroker? transport_broker {
				get;
				set;
			}

			public RemoteServer (HostSession session, DBusConnection connection, Flavor flavor,
					TransportBroker? transport_broker) {
				Object (
					session: session,
					connection: connection,
					flavor: flavor,
					transport_broker: transport_broker
				);
			}
		}
	}
}
```